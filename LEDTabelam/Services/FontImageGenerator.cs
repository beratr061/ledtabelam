using SkiaSharp;
using System;
using System.Collections.Generic;
using System.IO;

namespace LEDTabelam.Services;

/// <summary>
/// Generates pixel font images for BMFont format
/// This is a utility class used to create the default font PNG
/// </summary>
public static class FontImageGenerator
{
    // 5x7 pixel patterns for characters (stored as binary strings for readability)
    // Each character is 5 pixels wide and 7 pixels tall (with 1 pixel padding = 8 total height)
    private static readonly Dictionary<int, string[]> CharacterPatterns = new()
    {
        // Space
        [32] = new[] { "    ", "    ", "    ", "    ", "    ", "    ", "    ", "    " },
        // !
        [33] = new[] { " #", " #", " #", " #", " #", "  ", " #", "  " },
        // "
        [34] = new[] { "# #", "# #", "   ", "   ", "   ", "   ", "   ", "   " },
        // Numbers 0-9
        [48] = new[] { " ### ", "#   #", "#  ##", "# # #", "##  #", "#   #", " ### ", "     " },
        [49] = new[] { " # ", "## ", " # ", " # ", " # ", " # ", "###", "   " },
        [50] = new[] { " ### ", "#   #", "    #", "  ## ", " #   ", "#    ", "#####", "     " },
        [51] = new[] { " ### ", "#   #", "    #", "  ## ", "    #", "#   #", " ### ", "     " },
        [52] = new[] { "   # ", "  ## ", " # # ", "#  # ", "#####", "   # ", "   # ", "     " },
        [53] = new[] { "#####", "#    ", "#### ", "    #", "    #", "#   #", " ### ", "     " },
        [54] = new[] { " ### ", "#    ", "#### ", "#   #", "#   #", "#   #", " ### ", "     " },
        [55] = new[] { "#####", "    #", "   # ", "  #  ", " #   ", " #   ", " #   ", "     " },
        [56] = new[] { " ### ", "#   #", "#   #", " ### ", "#   #", "#   #", " ### ", "     " },
        [57] = new[] { " ### ", "#   #", "#   #", " ####", "    #", "   # ", " ##  ", "     " },
        // A-Z
        [65] = new[] { " ### ", "#   #", "#   #", "#####", "#   #", "#   #", "#   #", "     " },
        [66] = new[] { "#### ", "#   #", "#   #", "#### ", "#   #", "#   #", "#### ", "     " },
        [67] = new[] { " ### ", "#   #", "#    ", "#    ", "#    ", "#   #", " ### ", "     " },
        [68] = new[] { "#### ", "#   #", "#   #", "#   #", "#   #", "#   #", "#### ", "     " },
        [69] = new[] { "#####", "#    ", "#    ", "#### ", "#    ", "#    ", "#####", "     " },
        [70] = new[] { "#####", "#    ", "#    ", "#### ", "#    ", "#    ", "#    ", "     " },
        [71] = new[] { " ### ", "#   #", "#    ", "# ###", "#   #", "#   #", " ### ", "     " },
        [72] = new[] { "#   #", "#   #", "#   #", "#####", "#   #", "#   #", "#   #", "     " },
        [73] = new[] { "#", "#", "#", "#", "#", "#", "#", " " },
        [74] = new[] { "#####", "   # ", "   # ", "   # ", "   # ", "#  # ", " ##  ", "     " },
        [75] = new[] { "#   #", "#  # ", "# #  ", "##   ", "# #  ", "#  # ", "#   #", "     " },
        [76] = new[] { "#    ", "#    ", "#    ", "#    ", "#    ", "#    ", "#####", "     " },
        [77] = new[] { "#   # ", "## ## ", "# # # ", "#   # ", "#   # ", "#   # ", "#   # ", "      " },
        [78] = new[] { "#   #", "##  #", "# # #", "#  ##", "#   #", "#   #", "#   #", "     " },
        [79] = new[] { " ### ", "#   #", "#   #", "#   #", "#   #", "#   #", " ### ", "     " },
        [80] = new[] { "#### ", "#   #", "#   #", "#### ", "#    ", "#    ", "#    ", "     " },
        [81] = new[] { " ### ", "#   #", "#   #", "#   #", "# # #", "#  # ", " ## #", "     " },
        [82] = new[] { "#### ", "#   #", "#   #", "#### ", "# #  ", "#  # ", "#   #", "     " },
        [83] = new[] { " ### ", "#   #", "#    ", " ### ", "    #", "#   #", " ### ", "     " },
        [84] = new[] { "#####", "  #  ", "  #  ", "  #  ", "  #  ", "  #  ", "  #  ", "     " },
        [85] = new[] { "#   #", "#   #", "#   #", "#   #", "#   #", "#   #", " ### ", "     " },
        [86] = new[] { "#   #", "#   #", "#   #", "#   #", " # # ", " # # ", "  #  ", "     " },
        [87] = new[] { "#   # ", "#   # ", "#   # ", "# # # ", "# # # ", "## ## ", "#   # ", "      " },
        [88] = new[] { "#   #", " # # ", "  #  ", "  #  ", "  #  ", " # # ", "#   #", "     " },
        [89] = new[] { "#   #", " # # ", "  #  ", "  #  ", "  #  ", "  #  ", "  #  ", "     " },
        [90] = new[] { "#####", "    #", "   # ", "  #  ", " #   ", "#    ", "#####", "     " },
        // a-z (lowercase)
        [97] = new[] { "     ", "     ", " ### ", "    #", " ####", "#   #", " ####", "     " },
        [98] = new[] { "#    ", "#    ", "#### ", "#   #", "#   #", "#   #", "#### ", "     " },
        [99] = new[] { "     ", "     ", " ### ", "#    ", "#    ", "#   #", " ### ", "     " },
        [100] = new[] { "    #", "    #", " ####", "#   #", "#   #", "#   #", " ####", "     " },
        [101] = new[] { "     ", "     ", " ### ", "#   #", "#####", "#    ", " ### ", "     " },
        [102] = new[] { "  # ", " #  ", "### ", " #  ", " #  ", " #  ", " #  ", "    " },
        [103] = new[] { "     ", " ####", "#   #", "#   #", " ####", "    #", " ### ", "     " },
        [104] = new[] { "#    ", "#    ", "#### ", "#   #", "#   #", "#   #", "#   #", "     " },
        [105] = new[] { "#", " ", "#", "#", "#", "#", "#", " " },
        [106] = new[] { " #", "  ", " #", " #", " #", " #", "# ", "  " },
        [107] = new[] { "#    ", "#    ", "#  # ", "# #  ", "##   ", "# #  ", "#  # ", "     " },
        [108] = new[] { "#", "#", "#", "#", "#", "#", "#", " " },
        [109] = new[] { "      ", "      ", "## ## ", "# # # ", "# # # ", "#   # ", "#   # ", "      " },
        [110] = new[] { "     ", "     ", "#### ", "#   #", "#   #", "#   #", "#   #", "     " },
        [111] = new[] { "     ", "     ", " ### ", "#   #", "#   #", "#   #", " ### ", "     " },
        [112] = new[] { "     ", "#### ", "#   #", "#   #", "#### ", "#    ", "#    ", "     " },
        [113] = new[] { "     ", " ####", "#   #", "#   #", " ####", "    #", "    #", "     " },
        [114] = new[] { "    ", "    ", "# ##", "##  ", "#   ", "#   ", "#   ", "    " },
        [115] = new[] { "     ", "     ", " ####", "#    ", " ### ", "    #", "#### ", "     " },
        [116] = new[] { " #  ", " #  ", "### ", " #  ", " #  ", " #  ", "  # ", "    " },
        [117] = new[] { "     ", "     ", "#   #", "#   #", "#   #", "#   #", " ####", "     " },
        [118] = new[] { "     ", "     ", "#   #", "#   #", " # # ", " # # ", "  #  ", "     " },
        [119] = new[] { "      ", "      ", "#   # ", "#   # ", "# # # ", "# # # ", " # #  ", "      " },
        [120] = new[] { "     ", "     ", "#   #", " # # ", "  #  ", " # # ", "#   #", "     " },
        [121] = new[] { "     ", "#   #", "#   #", "#   #", " ####", "    #", " ### ", "     " },
        [122] = new[] { "     ", "     ", "#####", "   # ", "  #  ", " #   ", "#####", "     " },
        // Turkish characters
        // Ç (199)
        [199] = new[] { " ### ", "#   #", "#    ", "#    ", "#    ", "#   #", " ### ", "  #  " },
        // ç (231)
        [231] = new[] { "     ", "     ", " ### ", "#    ", "#    ", " ### ", "  #  ", "     " },
        // Ğ (286)
        [286] = new[] { " # # ", " ### ", "#   #", "#    ", "# ###", "#   #", " ### ", "     " },
        // ğ (287)
        [287] = new[] { " # # ", " ####", "#   #", "#   #", " ####", "    #", " ### ", "     " },
        // İ (304)
        [304] = new[] { "#", " ", "#", "#", "#", "#", "#", " " },
        // ı (305)
        [305] = new[] { " ", " ", "#", "#", "#", "#", "#", " " },
        // Ö (214)
        [214] = new[] { "# # ", " ## ", "#  #", "#  #", "#  #", "#  #", " ## ", "    " },
        // ö (246)
        [246] = new[] { "# # ", "    ", " ## ", "#  #", "#  #", "#  #", " ## ", "    " },
        // Ş (350)
        [350] = new[] { " ### ", "#    ", " ### ", "    #", "#   #", " ### ", "  #  ", "     " },
        // ş (351)
        [351] = new[] { "     ", " ####", "#    ", " ### ", "    #", "#### ", "  #  ", "     " },
        // Ü (220)
        [220] = new[] { "# # ", "    ", "#  #", "#  #", "#  #", "#  #", " ## ", "    " },
        // ü (252)
        [252] = new[] { "# # ", "    ", "#  #", "#  #", "#  #", "#  #", " ###", "    " },
        // Placeholder □ (9633)
        [9633] = new[] { "#####", "#   #", "#   #", "#   #", "#   #", "#   #", "#####", "     " },
    };

    /// <summary>
    /// Generates the font PNG image
    /// </summary>
    public static SKBitmap GenerateFontImage()
    {
        const int width = 256;
        const int height = 64;
        
        var bitmap = new SKBitmap(width, height);
        using var canvas = new SKCanvas(bitmap);
        canvas.Clear(SKColors.Transparent);

        using var paint = new SKPaint
        {
            Color = SKColors.White,
            IsAntialias = false
        };

        // Draw each character at its position
        foreach (var kvp in CharacterPatterns)
        {
            var charId = kvp.Key;
            var pattern = kvp.Value;
            
            // Get position from the font definition
            var (x, y) = GetCharacterPosition(charId);
            
            DrawCharacter(canvas, paint, pattern, x, y);
        }

        return bitmap;
    }

    private static (int x, int y) GetCharacterPosition(int charId)
    {
        // Map character IDs to their positions in the font image
        // This matches the positions defined in PixelFont8.fnt
        return charId switch
        {
            32 => (0, 0),    // Space
            33 => (4, 0),    // !
            48 => (61, 0),   // 0
            49 => (66, 0),   // 1
            50 => (69, 0),   // 2
            51 => (74, 0),   // 3
            52 => (79, 0),   // 4
            53 => (84, 0),   // 5
            54 => (89, 0),   // 6
            55 => (94, 0),   // 7
            56 => (99, 0),   // 8
            57 => (104, 0),  // 9
            65 => (136, 0),  // A
            66 => (141, 0),  // B
            67 => (146, 0),  // C
            68 => (151, 0),  // D
            69 => (156, 0),  // E
            70 => (161, 0),  // F
            71 => (166, 0),  // G
            72 => (171, 0),  // H
            73 => (176, 0),  // I
            74 => (178, 0),  // J
            75 => (183, 0),  // K
            76 => (188, 0),  // L
            77 => (193, 0),  // M
            78 => (199, 0),  // N
            79 => (204, 0),  // O
            80 => (209, 0),  // P
            81 => (214, 0),  // Q
            82 => (219, 0),  // R
            83 => (224, 0),  // S
            84 => (229, 0),  // T
            85 => (234, 0),  // U
            86 => (239, 0),  // V
            87 => (244, 0),  // W
            88 => (0, 8),    // X
            89 => (5, 8),    // Y
            90 => (10, 8),   // Z
            97 => (36, 8),   // a
            98 => (41, 8),   // b
            99 => (46, 8),   // c
            100 => (51, 8),  // d
            101 => (56, 8),  // e
            102 => (61, 8),  // f
            103 => (65, 8),  // g
            104 => (70, 8),  // h
            105 => (75, 8),  // i
            106 => (77, 8),  // j
            107 => (80, 8),  // k
            108 => (85, 8),  // l
            109 => (87, 8),  // m
            110 => (93, 8),  // n
            111 => (98, 8),  // o
            112 => (103, 8), // p
            113 => (108, 8), // q
            114 => (113, 8), // r
            115 => (117, 8), // s
            116 => (122, 8), // t
            117 => (126, 8), // u
            118 => (131, 8), // v
            119 => (136, 8), // w
            120 => (142, 8), // x
            121 => (147, 8), // y
            122 => (152, 8), // z
            // Turkish characters
            199 => (0, 16),  // Ç
            231 => (5, 16),  // ç
            286 => (10, 16), // Ğ
            287 => (15, 16), // ğ
            304 => (20, 16), // İ
            305 => (22, 16), // ı
            214 => (24, 16), // Ö
            246 => (29, 16), // ö
            350 => (34, 16), // Ş
            351 => (39, 16), // ş
            220 => (44, 16), // Ü
            252 => (49, 16), // ü
            9633 => (54, 16), // □
            _ => (0, 0)
        };
    }

    private static void DrawCharacter(SKCanvas canvas, SKPaint paint, string[] pattern, int startX, int startY)
    {
        for (int y = 0; y < pattern.Length && y < 8; y++)
        {
            var row = pattern[y];
            for (int x = 0; x < row.Length; x++)
            {
                if (row[x] == '#')
                {
                    canvas.DrawPoint(startX + x, startY + y, paint);
                }
            }
        }
    }

    /// <summary>
    /// Saves the font image to a file
    /// </summary>
    public static void SaveFontImage(string path)
    {
        using var bitmap = GenerateFontImage();
        using var image = SKImage.FromBitmap(bitmap);
        using var data = image.Encode(SKEncodedImageFormat.Png, 100);
        using var stream = File.OpenWrite(path);
        data.SaveTo(stream);
    }
}
